# 小规模品质管理系统局域网部署方案

**版本**: 2025-08-08  
**适用场景**: 20人以内小规模局域网试用  
**部署方式**: 单机部署（后端+数据库）+ 局域网访问  

---

## 目录
1. [系统概述](#系统概述)
2. [部署架构](#部署架构)
3. [准备工作](#准备工作)
4. [数据库配置](#数据库配置)
5. [后端部署](#后端部署)
6. [前端部署](#前端部署)
7. [局域网配置](#局域网配置)
8. [系统启动](#系统启动)
9. [访问测试](#访问测试)
10. [故障排除](#故障排除)
11. [安全建议](#安全建议)
12. [维护指南](#维护指南)

---

## 系统概述

### 技术栈
- **前端**: React 18 + TypeScript + Vite + Ant Design 5.x
- **后端**: Node.js + Express + Mongoose
- **数据库**: MongoDB (Atlas云数据库 或 本地MongoDB)
- **状态管理**: Zustand
- **构建工具**: Vite
- **包管理**: npm

### 系统功能模块
- ✅ 用户认证与权限管理
- ✅ Bug管理（创建、编辑、状态跟踪）
- ✅ 项目管理
- ✅ 任务管理
- ✅ 团队管理
- ✅ 系统日志
- ✅ 数据导入导出
- ✅ 文件上传

---

## 部署架构

```
局域网用户 (192.168.1.x)
    ↓
办公电脑 (192.168.1.100)
├── 前端服务 (端口3000)
├── 后端服务 (端口5001)
└── 数据库
    ├── 选项A: MongoDB Atlas (云数据库)
    └── 选项B: 本地MongoDB (端口27017)
```

---

## 准备工作

### 1. 系统要求
- **操作系统**: Windows 10/11, macOS, Linux
- **内存**: 最低4GB，推荐8GB
- **存储**: 最低10GB可用空间
- **网络**: 局域网环境，办公电脑需要固定IP

### 2. 软件安装
```bash
# 1. 安装Node.js (推荐v18.x或更高版本)
# 下载地址: https://nodejs.org/

# 2. 安装Git (用于代码管理)
# 下载地址: https://git-scm.com/

# 3. 验证安装
node --version
npm --version
git --version
```

### 3. 网络配置
```bash
# 查看本机IP地址
# Windows
ipconfig

# macOS/Linux
ifconfig
# 或
ip addr show
```

**记录办公电脑的局域网IP地址**，如：`192.168.1.100`

---

## 数据库配置

### 选项A: MongoDB Atlas (推荐)

#### A1. 注册和创建集群
1. 访问 [MongoDB Atlas](https://www.mongodb.com/atlas)
2. 注册账号并登录
3. 创建免费集群 (M0级别，512MB存储)
4. 选择云服务商和地区 (建议选择离您最近的)

#### A2. 配置数据库用户
1. 左侧菜单 → Database Access
2. 点击 "Add New Database User"
3. 设置用户名和密码：
   ```
   Username: bugapp
   Password: [设置强密码]
   Privileges: Read and write to any database
   ```

#### A3. 配置网络访问
1. 左侧菜单 → Network Access
2. 点击 "Add IP Address"
3. 添加IP地址：
   ```
   0.0.0.0/0  (允许所有IP访问，适合测试)
   ```
   **注意**: 生产环境建议只添加办公网段IP

#### A4. 获取连接字符串
1. 回到Cluster页面，点击 "Connect"
2. 选择 "Connect your application"
3. 复制连接字符串，格式如下：
   ```
   mongodb+srv://bugapp:[PASSWORD]@cluster0.xxxxx.mongodb.net/bug-management-system?retryWrites=true&w=majority
   ```

### 选项B: 本地MongoDB

#### B1. 安装MongoDB
**Windows:**
1. 下载 [MongoDB Community Server](https://www.mongodb.com/try/download/community)
2. 选择 "Complete" 安装
3. 安装MongoDB Compass (图形化管理工具)

**macOS:**
```bash
# 使用Homebrew安装
brew tap mongodb/brew
brew install mongodb-community
```

**Linux (Ubuntu):**
```bash
# 导入MongoDB公钥
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -

# 添加MongoDB源
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list

# 安装MongoDB
sudo apt-get update
sudo apt-get install -y mongodb-org
```

#### B2. 启动MongoDB服务
**Windows:**
```bash
# MongoDB服务应该已自动启动
# 检查服务状态
services.msc
# 查找 "MongoDB" 服务
```

**macOS/Linux:**
```bash
# 启动MongoDB服务
sudo systemctl start mongod
sudo systemctl enable mongod

# 检查服务状态
sudo systemctl status mongod
```

#### B3. 创建数据库和用户
```bash
# 连接到MongoDB
mongosh

# 切换到admin数据库
use admin

# 创建管理员用户
db.createUser({
  user: "admin",
  pwd: "adminpassword",
  roles: ["userAdminAnyDatabase", "dbAdminAnyDatabase", "readWriteAnyDatabase"]
})

# 切换到应用数据库
use bug-management-system

# 创建应用用户
db.createUser({
  user: "bugapp",
  pwd: "bugapppassword",
  roles: ["readWrite"]
})

# 退出
exit
```

#### B4. 配置MongoDB网络访问
编辑MongoDB配置文件：

**Windows:** `C:\Program Files\MongoDB\Server\6.0\bin\mongod.cfg`
**Linux:** `/etc/mongod.conf`
**macOS:** `/usr/local/etc/mongod.conf`

```yaml
# 网络配置
net:
  port: 27017
  bindIp: 0.0.0.0  # 允许所有IP访问

# 安全配置
security:
  authorization: enabled
```

重启MongoDB服务：
```bash
# Windows
net stop MongoDB
net start MongoDB

# Linux/macOS
sudo systemctl restart mongod
```

---

## 后端部署

### 1. 下载项目代码
```bash
# 克隆项目到本地
git clone https://github.com/kk-ahmean/Quality-Manage-System.git
cd Quality-Manage-System
```

### 2. 安装后端依赖
```bash
cd server
npm install
```

### 3. 配置环境变量
编辑 `server/config.env` 文件：

**使用MongoDB Atlas:**
```env
# MongoDB Atlas连接
MONGODB_URI=mongodb+srv://bugapp:[YOUR_PASSWORD]@cluster0.xxxxx.mongodb.net/bug-management-system?retryWrites=true&w=majority

# JWT密钥
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# 服务器配置
PORT=5001
NODE_ENV=production

# CORS配置 (允许局域网访问)
CORS_ORIGIN=http://192.168.1.100:3000

# 使用真实数据库
USE_MEMORY_DB=false
```

**使用本地MongoDB:**
```env
# 本地MongoDB连接
MONGODB_URI=mongodb://bugapp:bugapppassword@192.168.1.100:27017/bug-management-system

# JWT密钥
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# 服务器配置
PORT=5001
NODE_ENV=production

# CORS配置 (允许局域网访问)
CORS_ORIGIN=http://192.168.1.100:3000

# 使用真实数据库
USE_MEMORY_DB=false
```

### 4. 启动后端服务
```bash
# 开发模式
npm run dev

# 生产模式
npm start
```

**验证后端启动:**
```bash
# 测试健康检查
curl http://localhost:5001/api/health

# 预期返回: {"status":"ok","message":"Server is running"}
```

---

## 前端部署

### 1. 安装前端依赖
```bash
# 回到项目根目录
cd ..
npm install
```

### 2. 配置API地址
编辑 `src/config/api.ts` 文件：

```typescript
const currentHost = window.location.hostname;
const isDevelopment = import.meta.env.DEV;

export const API_CONFIG = {
  baseURL: isDevelopment 
    ? `http://${currentHost}:5001/api`
    : `http://192.168.1.100:5001/api`, // 替换为办公电脑IP
  timeout: 10000,
};
```

### 3. 构建前端
```bash
# 构建生产版本
npm run build
```

### 4. 启动前端服务
```bash
# 使用http-server启动静态文件服务
npm install -g http-server

# 启动前端服务 (端口3000)
http-server dist -p 3000 -a 0.0.0.0
```

**或者使用Vite开发服务器:**
```bash
# 开发模式
npm run dev -- --host 0.0.0.0
```

---

## 局域网配置

### 1. 防火墙配置
**Windows防火墙:**
1. 打开 "Windows Defender 防火墙"
2. 点击 "允许应用或功能通过Windows Defender防火墙"
3. 添加以下应用:
   - Node.js (端口5001)
   - http-server (端口3000)
   - MongoDB (端口27017，如果使用本地MongoDB)

**或使用命令行:**
```bash
# 允许Node.js通过防火墙
netsh advfirewall firewall add rule name="Node.js Backend" dir=in action=allow protocol=TCP localport=5001
netsh advfirewall firewall add rule name="Node.js Frontend" dir=in action=allow protocol=TCP localport=3000

# 如果使用本地MongoDB
netsh advfirewall firewall add rule name="MongoDB" dir=in action=allow protocol=TCP localport=27017
```

### 2. 路由器配置 (可选)
如果局域网内无法访问，可能需要在路由器上配置端口转发：
- 端口3000 → 办公电脑IP
- 端口5001 → 办公电脑IP

---

## 系统启动

### 1. 启动脚本
创建启动脚本 `start-system.bat` (Windows) 或 `start-system.sh` (Linux/macOS):

**Windows (start-system.bat):**
```batch
@echo off
echo 启动品质管理系统...

echo 1. 启动后端服务...
cd server
start "Backend Server" cmd /k "npm start"

echo 2. 等待后端启动...
timeout /t 5

echo 3. 启动前端服务...
cd ..
start "Frontend Server" cmd /k "http-server dist -p 3000 -a 0.0.0.0"

echo 系统启动完成！
echo 前端地址: http://192.168.1.100:3000
echo 后端地址: http://192.168.1.100:5001
pause
```

**Linux/macOS (start-system.sh):**
```bash
#!/bin/bash
echo "启动品质管理系统..."

echo "1. 启动后端服务..."
cd server
npm start &
BACKEND_PID=$!

echo "2. 等待后端启动..."
sleep 5

echo "3. 启动前端服务..."
cd ..
http-server dist -p 3000 -a 0.0.0.0 &
FRONTEND_PID=$!

echo "系统启动完成！"
echo "前端地址: http://192.168.1.100:3000"
echo "后端地址: http://192.168.1.100:5001"

# 等待用户中断
trap "echo '正在关闭服务...'; kill $BACKEND_PID $FRONTEND_PID; exit" INT
wait
```

### 2. 使用PM2管理进程 (推荐)
```bash
# 安装PM2
npm install -g pm2

# 创建PM2配置文件 ecosystem.config.js
```

**ecosystem.config.js:**
```javascript
module.exports = {
  apps: [
    {
      name: 'bug-management-backend',
      cwd: './server',
      script: 'server.js',
      env: {
        NODE_ENV: 'production',
        PORT: 5001
      },
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G'
    },
    {
      name: 'bug-management-frontend',
      script: 'http-server',
      args: 'dist -p 3000 -a 0.0.0.0',
      env: {
        NODE_ENV: 'production'
      },
      instances: 1,
      autorestart: true,
      watch: false
    }
  ]
};
```

**启动服务:**
```bash
# 启动所有服务
pm2 start ecosystem.config.js

# 查看服务状态
pm2 status

# 查看日志
pm2 logs

# 停止服务
pm2 stop all

# 重启服务
pm2 restart all
```

---

## 访问测试

### 1. 本地测试
```bash
# 测试后端API
curl http://localhost:5001/api/health

# 测试前端
curl http://localhost:3000
```

### 2. 局域网测试
在其他电脑上打开浏览器，访问：
```
http://192.168.1.100:3000
```

### 3. 功能测试
1. **登录测试**: 使用演示账户
   - admin / 123456
   - developer / 123456
   - tester / 123456

2. **功能测试**: 测试各个模块功能
   - 用户管理
   - Bug管理
   - 项目管理
   - 任务管理

---

## 故障排除

### 1. 常见问题

**问题1: 前端无法连接后端**
```bash
# 检查后端是否启动
curl http://localhost:5001/api/health

# 检查防火墙设置
# 检查CORS配置
```

**问题2: 数据库连接失败**
```bash
# MongoDB Atlas
# 检查网络连接字符串
# 检查IP白名单设置
# 检查用户名密码

# 本地MongoDB
# 检查MongoDB服务状态
sudo systemctl status mongod

# 检查网络配置
netstat -an | grep 27017
```

**问题3: 局域网无法访问**
```bash
# 检查IP地址
ipconfig

# 检查防火墙
netsh advfirewall firewall show rule name=all

# 检查端口是否开放
netstat -an | findstr :3000
netstat -an | findstr :5001
```

### 2. 日志查看
```bash
# 后端日志
cd server
npm run dev

# PM2日志
pm2 logs

# MongoDB日志
# Windows: 查看事件查看器
# Linux: sudo journalctl -u mongod
```

### 3. 重置系统
```bash
# 停止所有服务
pm2 stop all
pm2 delete all

# 清理数据库 (谨慎操作)
# MongoDB Atlas: 在控制台删除数据库
# 本地MongoDB: 
mongosh
use bug-management-system
db.dropDatabase()
exit

# 重新启动
pm2 start ecosystem.config.js
```

---

## 安全建议

### 1. 网络安全
- 限制局域网访问范围
- 配置防火墙规则
- 使用HTTPS (生产环境)
- 定期更新系统和软件

### 2. 数据库安全
- 使用强密码
- 限制数据库访问IP
- 定期备份数据
- 启用数据库认证

### 3. 应用安全
- 修改默认JWT密钥
- 设置密码复杂度要求
- 启用用户会话管理
- 记录系统访问日志

### 4. 数据备份
```bash
# MongoDB Atlas备份
# 在Atlas控制台配置自动备份

# 本地MongoDB备份
mongodump --host localhost --port 27017 --db bug-management-system --out ./backup

# 恢复备份
mongorestore --host localhost --port 27017 --db bug-management-system ./backup/bug-management-system
```

---

## 维护指南

### 1. 日常维护
- 监控系统运行状态
- 检查磁盘空间
- 查看错误日志
- 备份重要数据

### 2. 性能优化
- 监控内存使用
- 优化数据库查询
- 配置缓存策略
- 负载均衡 (如需要)

### 3. 更新升级
```bash
# 更新代码
git pull origin main

# 更新依赖
npm install

# 重新构建前端
npm run build

# 重启服务
pm2 restart all
```

### 4. 监控工具
```bash
# 系统监控
pm2 monit

# 进程监控
pm2 status

# 日志监控
pm2 logs --lines 100
```

---

## 联系支持

如遇到问题，请提供以下信息：
1. 操作系统版本
2. Node.js版本
3. 错误日志
4. 网络环境
5. 具体错误信息

---

**部署完成时间**: ___________  
**部署人员**: ___________  
**备注**: ___________ 