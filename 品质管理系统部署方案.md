# 品质管理系统部署方案

## 系统概述

品质管理系统是一个基于React + Node.js的现代化Web应用，提供Bug跟踪、任务管理、用户管理等功能。

### 技术架构
- **前端**: React 18 + TypeScript + Ant Design + Vite
- **后端**: Node.js + Express + MongoDB
- **状态管理**: Zustand

## 部署环境要求

### 最低系统要求
- **操作系统**: Windows 10/11, Linux (Ubuntu 18.04+), macOS 10.15+
- **CPU**: 双核 2.0GHz
- **内存**: 4GB RAM
- **存储**: 10GB 可用空间

### 软件要求
- **Node.js**: 16.x 或更高版本
- **npm**: 8.x 或更高版本
- **MongoDB**: 4.4+ (可选，系统支持内存数据库模式)

## 单机部署方案

### 开发环境部署

#### 1. 环境准备
```bash
# 检查Node.js版本
node --version  # 应显示 v16.x 或更高
npm --version   # 应显示 8.x 或更高
```

#### 2. 项目下载
```bash
# 克隆项目或解压项目文件
cd bug-management-system
```

#### 3. 依赖安装
```bash
# 安装前端依赖
npm install

# 安装后端依赖
cd server
npm install
cd ..
```

#### 4. 配置文件设置
编辑 `server/config.env` 文件：
```env
# JWT密钥
JWT_SECRET=your-super-secret-jwt-key-here

# 服务器配置
PORT=5001
NODE_ENV=development

# CORS配置
CORS_ORIGIN=http://localhost:3000

# 内存数据库模式（推荐开发环境使用）
USE_MEMORY_DB=true
```

#### 5. 启动服务
```bash
# 使用启动脚本（推荐）
node start-servers.cjs

# 或分别启动
# 终端1：启动后端
cd server && npm start

# 终端2：启动前端
npm run dev
```

#### 6. 验证部署
- 前端访问: http://localhost:3000/Quality-Manage-System/
- 后端API: http://localhost:5001/api/health
- 测试账户: admin@example.com / 123456

### 生产环境部署

#### 1. 构建生产版本
```bash
# 构建前端
npm run build
```

#### 2. 使用PM2管理进程
```bash
# 安装PM2
npm install -g pm2

# 创建PM2配置文件 ecosystem.config.js
```

**ecosystem.config.js:**
```javascript
module.exports = {
  apps: [
    {
      name: 'bug-management-backend',
      script: './server/server.js',
      cwd: './server',
      env: {
        NODE_ENV: 'production',
        PORT: 5001
      },
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G'
    },
    {
      name: 'bug-management-frontend',
      script: 'serve',
      args: '-s dist -l 3000',
      env: {
        NODE_ENV: 'production'
      }
    }
  ]
};
```

#### 3. 启动服务
```bash
# 启动所有服务
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs
```

## 局域网多机部署方案

### 网络架构
```
[客户端] ←→ [前端服务器: 192.168.1.100:3000] ←→ [后端服务器: 192.168.1.101:5001] ←→ [数据库服务器: 192.168.1.102:27017]
```

### 1. 前端服务器配置 (192.168.1.100)

#### 安装Node.js
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 下载项目
git clone <repository-url>
cd bug-management-system

# 安装依赖并构建
npm install
npm run build
```

#### 配置Nginx
```bash
# 安装Nginx
sudo apt-get install nginx

# 配置Nginx
sudo nano /etc/nginx/sites-available/bug-management
```

**Nginx配置：**
```nginx
server {
    listen 80;
    server_name 192.168.1.100;

    location / {
        root /path/to/bug-management-system/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    location /api {
        proxy_pass http://192.168.1.101:5001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/bug-management /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 2. 后端服务器配置 (192.168.1.101)

#### 安装Node.js和MongoDB
```bash
# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装MongoDB
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org

# 启动MongoDB
sudo systemctl start mongod
sudo systemctl enable mongod
```

#### 配置后端
```bash
# 下载项目后端部分
cd /opt
git clone <repository-url> bug-management-system
cd bug-management-system/server

# 安装依赖
npm install

# 配置环境变量
nano config.env
```

**config.env配置：**
```env
# MongoDB连接配置
MONGODB_URI=mongodb://192.168.1.102:27017/bug-management-system

# JWT密钥
JWT_SECRET=your-production-jwt-secret-key-here

# 服务器配置
PORT=5001
NODE_ENV=production

# CORS配置
CORS_ORIGIN=http://192.168.1.100

# 禁用内存数据库模式
USE_MEMORY_DB=false
```

#### 使用PM2启动
```bash
# 安装PM2
npm install -g pm2

# 启动服务
pm2 start server.js --name "bug-management-backend"

# 设置开机自启
pm2 startup
pm2 save
```

### 3. 数据库服务器配置 (192.168.1.102)

#### MongoDB配置
```bash
# 编辑MongoDB配置
sudo nano /etc/mongod.conf
```

**mongod.conf配置：**
```yaml
# network interfaces
net:
  port: 27017
  bindIp: 0.0.0.0  # 允许远程连接

# 安全配置
security:
  authorization: enabled

# 数据目录
storage:
  dbPath: /var/lib/mongodb
  journal:
    enabled: true

# 日志配置
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log
```

#### 创建数据库用户
```bash
# 连接到MongoDB
mongo

# 创建管理员用户
use admin
db.createUser({
  user: "admin",
  pwd: "adminpassword",
  roles: ["userAdminAnyDatabase", "dbAdminAnyDatabase", "readWriteAnyDatabase"]
})

# 创建应用数据库用户
use bug-management-system
db.createUser({
  user: "bugapp",
  pwd: "bugapppassword",
  roles: ["readWrite"]
})

# 退出
exit
```

```bash
# 重启MongoDB
sudo systemctl restart mongod
```

## Docker容器化部署

### 创建Docker Compose配置

**docker-compose.yml:**
```yaml
version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - bug-management-network

  backend:
    build:
      context: ./server
      dockerfile: Dockerfile.backend
    ports:
      - "5001:5001"
    environment:
      - NODE_ENV=production
      - PORT=5001
      - MONGODB_URI=mongodb://mongodb:27017/bug-management-system
      - JWT_SECRET=your-production-jwt-secret
      - USE_MEMORY_DB=false
    depends_on:
      - mongodb
    networks:
      - bug-management-network

  mongodb:
    image: mongo:5.0
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=adminpassword
      - MONGO_INITDB_DATABASE=bug-management-system
    volumes:
      - mongodb_data:/data/db
    networks:
      - bug-management-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    networks:
      - bug-management-network

networks:
  bug-management-network:
    driver: bridge

volumes:
  mongodb_data:
```

### 创建Dockerfile

**Dockerfile.frontend:**
```dockerfile
# 构建阶段
FROM node:18-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# 生产阶段
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**Dockerfile.backend:**
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 5001
CMD ["node", "server.js"]
```

### 部署命令
```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 数据库配置

### MongoDB配置选项

#### 1. 内存数据库模式（开发/测试环境）
```env
USE_MEMORY_DB=true
```
- 优点：无需安装MongoDB，启动快速
- 缺点：数据不持久化，重启后数据丢失

#### 2. MongoDB单机模式（生产环境）
```env
MONGODB_URI=mongodb://localhost:27017/bug-management-system
USE_MEMORY_DB=false
```

#### 3. MongoDB集群模式（高可用环境）
```env
MONGODB_URI=mongodb://192.168.1.100:27017,192.168.1.101:27017,192.168.1.102:27017/bug-management-system?replicaSet=bug-management-replica
USE_MEMORY_DB=false
```

### 数据库备份策略

#### 自动备份脚本
```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mongodb"
DB_NAME="bug-management-system"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
mongodump --db $DB_NAME --out $BACKUP_DIR/$DATE

# 压缩备份文件
tar -czf $BACKUP_DIR/$DATE.tar.gz $BACKUP_DIR/$DATE

# 删除未压缩的备份目录
rm -rf $BACKUP_DIR/$DATE

# 保留最近7天的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $BACKUP_DIR/$DATE.tar.gz"
```

#### 定时备份配置
```bash
# 添加到crontab
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /path/to/backup.sh
```

## 安全配置

### 1. 网络安全

#### 防火墙配置
```bash
# Ubuntu/Debian
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 3000/tcp  # 前端服务
sudo ufw allow 5001/tcp  # 后端API
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --permanent --add-port=5001/tcp
sudo firewall-cmd --reload
```

#### SSL/TLS配置
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    location / {
        proxy_pass http://frontend_servers;
    }

    location /api {
        proxy_pass http://backend_servers;
    }
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 2. 应用安全

#### JWT密钥管理
```env
# 生成强密钥
JWT_SECRET=$(openssl rand -base64 64)

# 或使用环境变量
JWT_SECRET=${JWT_SECRET}
```

#### API限流配置
```javascript
// 速率限制
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 1000, // 限制每个IP 15分钟内最多1000个请求
  message: '请求过于频繁，请稍后再试'
});
```

### 3. 数据安全

#### 数据库访问控制
```javascript
// MongoDB用户权限
db.createUser({
  user: "bugapp",
  pwd: "strongpassword",
  roles: [
    { role: "readWrite", db: "bug-management-system" }
  ]
});
```

## 监控与维护

### 1. 系统监控

#### 使用PM2监控
```bash
# 安装PM2监控
pm2 install pm2-server-monit

# 查看监控面板
pm2 monit

# 查看详细状态
pm2 show bug-management-backend
```

#### 日志管理
```bash
# 查看应用日志
pm2 logs bug-management-backend

# 查看错误日志
pm2 logs bug-management-backend --err

# 日志轮转配置
pm2 install pm2-logrotate
```

### 2. 健康检查

#### API健康检查端点
```javascript
app.get('/api/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    database: global.memoryDB ? 'Memory DB' : 'MongoDB'
  });
});
```

#### 自动健康检查脚本
```bash
#!/bin/bash
# health-check.sh

HEALTH_URL="http://localhost:5001/api/health"
MAX_RETRIES=3

for i in $(seq 1 $MAX_RETRIES); do
  response=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
  
  if [ $response -eq 200 ]; then
    echo "健康检查通过"
    exit 0
  else
    echo "健康检查失败，尝试 $i/$MAX_RETRIES"
    sleep 5
  fi
done

echo "健康检查失败，重启服务"
pm2 restart bug-management-backend
```

## 故障排除

### 1. 常见问题

#### 端口被占用
```bash
# 查看端口占用
netstat -tulpn | grep :5001

# 杀死占用进程
sudo kill -9 <PID>

# 或使用lsof
lsof -i :5001
```

#### 内存不足
```bash
# 查看内存使用
free -h

# 清理缓存
sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches

# 增加swap空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

#### 数据库连接失败
```bash
# 检查MongoDB状态
sudo systemctl status mongod

# 重启MongoDB
sudo systemctl restart mongod

# 检查MongoDB日志
sudo journalctl -u mongod -f
```

### 2. 日志分析

#### 应用日志分析
```bash
# 查看错误日志
pm2 logs bug-management-backend --err | grep ERROR

# 查看慢查询日志
pm2 logs bug-management-backend | grep "slow"

# 实时监控日志
pm2 logs bug-management-backend --lines 100 -f
```

#### 系统日志分析
```bash
# 查看系统日志
sudo journalctl -f

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 3. 性能优化

#### 前端优化
```bash
# 构建优化
npm run build -- --mode production

# 启用gzip压缩
# 在Nginx配置中添加
gzip on;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
```

#### 后端优化
```javascript
// 启用压缩
app.use(compression());

// 缓存静态资源
app.use(express.static('public', {
  maxAge: '1d',
  etag: true
}));

// 数据库连接池
mongoose.connect(uri, {
  maxPoolSize: 10,
  serverSelectionTimeoutMS: 5000,
  socketTimeoutMS: 45000,
});
```

### 4. 备份恢复

#### 数据备份
```bash
# 创建备份
mongodump --db bug-management-system --out /backup/$(date +%Y%m%d)

# 压缩备份
tar -czf /backup/$(date +%Y%m%d).tar.gz /backup/$(date +%Y%m%d)
```

#### 数据恢复
```bash
# 恢复数据
mongorestore --db bug-management-system /backup/20240101/bug-management-system/

# 从压缩文件恢复
tar -xzf /backup/20240101.tar.gz
mongorestore --db bug-management-system /backup/20240101/bug-management-system/
```

## 总结

本部署方案提供了从单机开发环境到生产环境集群的完整部署指南。根据实际需求选择合适的部署方案：

1. **开发测试**: 使用单机部署方案一（内存数据库）
2. **小规模使用**: 使用单机部署方案二（PM2管理）
3. **团队使用**: 使用局域网多机部署方案
4. **生产环境**: 使用生产环境部署方案（高可用架构）

建议在生产环境中：
- 使用HTTPS协议
- 配置数据库备份
- 设置监控告警
- 定期更新安全补丁
- 实施访问控制策略 